# ×¤×¨×•×™×§×˜ ×”×•×¨×“×ª ××¡××›×™ ×ª×›× ×•×Ÿ ×•×‘× ×™×™×” â€“ ×›×¤×¨ ×—×‘"×“
## ×¡×™×›×•× ×˜×›× ×™ ××œ×

---

## 1. ×¡×§×™×¨×” ×›×œ×œ×™×ª

×”×¤×¨×•×™×§×˜ ××•×¨×™×“ **××ª ×›×œ ××¡××›×™ ×”×ª×›× ×•×Ÿ ×•×”×‘× ×™×™×”** ×©×œ ×›×¤×¨ ×—×‘"×“ ×××¢×¨×›×•×ª ×××©×œ×ª×™×•×ª ×©×•× ×•×ª, ×›×•×œ×œ:

- **×ª×›× ×™×•×ª ×‘× ×™×™×Ÿ ×¢×™×¨ (×ª×‘"×¢)** â€“ ×××ª×¨ ×©×“×•×ª ×“×Ÿ (SDAN)
- **×‘×§×©×•×ª ×œ×”×™×ª×¨×™ ×‘× ×™×™×”** â€“ ×××ª×¨ ×©×“×•×ª ×“×Ÿ (SDAN)
- **×¦×™×œ×•××™ ××•×•×™×¨ ×”×™×¡×˜×•×¨×™×™×** â€“ ×-GIS-net GeoServer (WMTS)
- **×’×™××•×¨×¤×¨× ×¡ ×œ×ª×©×¨×™×˜×™×** â€“ ×”×¦××“×ª ×§×•××•×¨×“×™× ×˜×•×ª ×œ×ª×©×¨×™×˜×™ ×ª×›× ×•×Ÿ

×›×œ ×”×¤×œ×˜ ×›×•×œ×œ **×§×‘×¦×™ ×’×™××•×¨×¤×¨× ×¡** (world files + projection files) ×›×š ×©× ×™×ª×Ÿ ×œ×¤×ª×•×— ×™×©×™×¨×•×ª ×‘-QGIS/ArcGIS.

---

## 2. ××‘× ×” ×”×¤×¨×•×™×§×˜

```
meida/
â”œâ”€â”€ sdan_common.py          # ××•×“×•×œ ××©×•×ª×£ â€“ Chrome driver, DB, ×’×¨×™×“×”
â”œâ”€â”€ download_plans.py       # ×”×•×¨×“×ª ×ª×›× ×™×•×ª ×‘× ×™×™×Ÿ ×¢×™×¨ (×ª×‘"×¢)
â”œâ”€â”€ download_permits.py     # ×”×•×¨×“×ª ×‘×§×©×•×ª ×œ×”×™×ª×¨×™ ×‘× ×™×™×”
â”œâ”€â”€ download_aerial.py      # ×”×•×¨×“×ª ×¦×™×œ×•××™ ××•×•×™×¨ ×¢× ×’×™××•×¨×¤×¨× ×¡
â”œâ”€â”€ georeference_plan.py    # ×›×œ×™ ×’×™××•×¨×¤×¨× ×¡ ×™×“× ×™ ×œ×ª×©×¨×™×˜×™×
â”œâ”€â”€ generate_georef.py      # ×™×¦×™×¨×ª ×’×™××•×¨×¤×¨× ×¡ ××•×˜×•××˜×™ ×œ×›×œ ×”×ª×©×¨×™×˜×™×
â”œâ”€â”€ run_all.py              # ×”×¨×¦×” ×›×•×œ×œ×ª ×©×œ ×›×œ ×”×¡×§×¨×™×¤×˜×™×
â”‚
â”œâ”€â”€ kfar_chabad_documents.db    # ××¡×“ × ×ª×•× ×™× SQLite â€“ ××¢×§×‘ ×”×•×¨×“×•×ª
â”œâ”€â”€ kfar_chabad_data/           # ×¤×œ×˜ ××¡××›×™×
â”‚   â””â”€â”€ plans/                  # ×ª×©×¨×™×˜×™× + .jgw + .prj
â”‚       â”œâ”€â”€ 6256_2/×’×–_12_525/  # ×’×•×©_×—×œ×§×”/×ª×›× ×™×ª/
â”‚       â”œâ”€â”€ 6260_1/×’×–_27_525_×/
â”‚       â””â”€â”€ georef_config.json  # ×§×•× ×¤×™×’×•×¨×¦×™×” ×©×œ ×”×’×™××•×¨×¤×¨× ×¡
â”‚
â””â”€â”€ gis_downloads/              # ×¤×œ×˜ ×¦×™×œ×•××™ ××•×•×™×¨
    â””â”€â”€ aerial/
        â”œâ”€â”€ 1965/level_7/       # ××¨×™×—×™× + ×ª××•× ×” ×ª×¤×•×¨×”
        â”œâ”€â”€ 2025.04/level_7/
        â””â”€â”€ ...                 # 10 ×©× ×•×ª ×¦×™×œ×•×
```

---

## 3. ×˜×›× ×•×œ×•×’×™×•×ª ×•×ª×œ×•×™×•×ª

### ×©×¤×ª ×ª×›× ×•×ª
- **Python 3.12.10** â€“ ×¢× virtual environment (`.venv/`)

### ×¡×¤×¨×™×•×ª ×¢×™×§×¨×™×•×ª

| ×¡×¤×¨×™×™×” | ×’×¨×¡×” | ×©×™××•×© |
|--------|-------|-------|
| **selenium** | 4.40.0 | ××•×˜×•××¦×™×” ×©×œ ×“×¤×“×¤×Ÿ Chrome â€“ ×’×¨×™×“×ª ××¡××›×™× ×•-XHR ×œ××¨×™×—×™ GIS |
| **webdriver-manager** | 4.0.2 | × ×™×”×•×œ ××•×˜×•××˜×™ ×©×œ chromedriver |
| **requests** | 2.32.5 | ×”×•×¨×“×ª ×§×‘×¦×™× ×™×©×™×¨×” (PDF, JPG) |
| **Pillow** | 12.1.1 | ×¢×™×‘×•×“ ×ª××•× ×•×ª â€“ ×ª×¤×™×¨×ª ××¨×™×—×™×, ×§×¨×™××ª metadata |
| **numpy** | 2.4.2 | ×—×™×©×•×‘×™ ×˜×¨× ×¡×¤×•×¨××¦×™×” ××¤×™× ×™×ª ×œ×’×™××•×¨×¤×¨× ×¡ |
| **PyMuPDF (fitz)** | 1.27.1 | ×”××¨×ª PDF â†’ ×ª××•× ×” ×‘×¨×–×•×œ×•×¦×™×” ×’×‘×•×”×” |
| **opencv-python-headless** | 4.13.0 | × ×™×¡×™×•×Ÿ ×”×ª×××ª ×¤×™×¦'×¨×™× (×œ× ×”×¦×œ×™×— â€“ ×¨××” ×¡×¢×™×£ 7) |
| **pytesseract** | â€“ | OCR ×œ×§×¨×™××ª ×§×•××•×¨×“×™× ×˜×•×ª ×××¤×•×ª (×”×¦×œ×—×” ×—×œ×§×™×ª) |

### ×›×œ×™× ×—×™×¦×•× ×™×™×
- **Google Chrome** 144.0.7559.133 â€“ ×“×¤×“×¤×Ÿ ×¢×‘×•×¨ Selenium
- **Tesseract OCR** â€“ ×× ×•×¢ OCR (×”×•×ª×§×Ÿ ×“×¨×š `winget`)

### ×¤×¨×•×˜×•×§×•×œ×™× ×•-APIs

| ×˜×›× ×•×œ×•×’×™×” | ×©×™××•×© | ××§×•×¨ |
|-----------|-------|------|
| **WMTS** (Web Map Tile Service) | ×”×•×¨×“×ª ××¨×™×—×™ ×¦×™×œ×•× ××•×•×™×¨ | GeoServer 2.x ×‘-GIS-net |
| **OGC GetCapabilities** | ×§×‘×œ×ª ×¤×¨××˜×¨×™× ×©×œ ×©×›×‘×•×ª | GeoServer WMTS endpoint |
| **ArcGIS JS API 3.35** | ×”-API ×©××¤×¢×™×œ ××ª ××ª×¨ GIS-net | ESRI |
| **Reverse Proxy** | `proxy.ashx` ××ª×•×•×š ×‘×™×Ÿ ×”×“×¤×“×¤×Ÿ ×œ-GeoServer ×”×¤× ×™××™ | GIS-net v5 |

### ××¢×¨×›×•×ª ×§×•××•×¨×“×™× ×˜×•×ª

| ×§×•×“ | ×©× | ×©×™××•×© |
|-----|-----|-------|
| **EPSG:2039** | Israel 1993 / Israeli TM Grid (ITM) | ××¢×¨×›×ª ×¨××©×™×ª â€“ ×¦×™×œ×•××™ ××•×•×™×¨ + ×ª×©×¨×™×˜×™× ×—×“×©×™× |
| **EPSG:6991** | Israel 1993 / Israeli CS Grid | ×¨×©×ª ×™×©× ×” â€“ ×ª×©×¨×™×˜×™× ×™×©× ×™× |

---

## 4. ×¤×™×¨×•×˜ ×›×œ ×¡×§×¨×™×¤×˜

### 4.1 `sdan_common.py` â€“ ××•×“×•×œ ××©×•×ª×£

**×ª×¤×§×™×“:** ×¡×¤×¨×™×™×” ××©×•×ª×¤×ª ×œ×›×œ ×¡×§×¨×™×¤×˜×™× ×©×œ SDAN (×©×“×•×ª ×“×Ÿ).

**××” ×‘×¤× ×™×:**
- **×¨×©×™××ª ×’×•×©×™×:** 12 ×’×•×©×™× ×©×œ ×›×¤×¨ ×—×‘"×“: `6256, 6258, 6260, 6261, 6262, 6269, 6272, 6280, 7187, 7188, 7196, 7311`
- **`SELECTORS`:** ××™×œ×•×Ÿ ×©×œ CSS selectors ×œ×›×œ ×§×˜×’×•×¨×™×” (plans/permits) â€“ ×›×ª×•×‘×ª URL, ×©×“×•×ª ×—×™×¤×•×©, ×›×¤×ª×•×¨×™×
- **`create_driver()`:** ×™×¦×™×¨×ª Chrome WebDriver ×¢× ×”×’× ×ª anti-detection (××•×¨×™×“ ××ª ×“×’×œ `webdriver` ×-navigator)
- **`process_gush()`:** ×”×¤×•× ×§×¦×™×” ×”×¢×™×§×¨×™×ª â€“ ×œ×•×œ××” ×¢×œ ×›×œ ×—×œ×§×•×ª ×‘×’×•×© (1-200), ×—×™×¤×•×©, ×¤×ª×™×—×ª modal, ×”×•×¨×“×ª ×›×œ ×”×§×‘×¦×™×
- **`extract_doc_links()`:** ×—×™×œ×•×¥ ×§×™×©×•×¨×™ ××¡××›×™× ××”-modal ×©× ×¤×ª×—
- **`open_db()`:** ××¡×“ × ×ª×•× ×™× SQLite ×œ××¢×§×‘ ××—×¨×™ ××” ×©×™×¨×“

**×˜×›× ×•×œ×•×’×™×”:**  
Selenium ×©×•×œ×˜ ×¢×œ Chrome â†’ × ×›× ×¡ ×œ××ª×¨ SDAN â†’ ×××œ× ×˜×•×¤×¡ (×’×•×©+×—×œ×§×”) â†’ ×œ×•×—×¥ "×”×¦×’" â†’ ×××ª×™×Ÿ ×œ×ª×•×¦××•×ª â†’ ×œ×•×—×¥ ×¢×œ ×›×¤×ª×•×¨ "××¨×›×™×•×Ÿ" â†’ ××—×œ×¥ ×œ×™× ×§×™× ××”-modal â†’ ××•×¨×™×“ ×‘-requests.

**××ª×’×¨×™× ×•×¤×ª×¨×•× ×•×ª:**
- ğŸ”§ **Banner cookies:** ×”×“×£ ××¦×™×’ ×‘×× ×¨ ×”×¡×›××” ×©××¡×ª×™×¨ ×›×¤×ª×•×¨×™× â†’ `dismiss_banner()` ××•×¦× ×•×œ×•×—×¥/××¡×ª×™×¨ ××•×ª×•
- ğŸ”§ **JavaScript click intercept:** ×œ×¤×¢××™× Selenium ×œ× ××¦×œ×™×— ×œ×œ×—×•×¥ ×¨×’×™×œ â†’ `safe_click()` ××©×ª××© ×‘-JavaScript fallback
- ğŸ”§ **Stale elements:** ××—×¨×™ ×¡×’×™×¨×ª modal ×”×©×•×¨×•×ª ××ª×¨×¢× × ×•×ª â†’ ×›×œ ××™×˜×¨×¦×™×” ××—×¤×©×ª ××ª ×”×©×•×¨×•×ª ××—×“×©

---

### 4.2 `download_plans.py` â€“ ×”×•×¨×“×ª ×ª×›× ×™×•×ª

**×ª×¤×§×™×“:** ××•×¨×™×“ ××ª ×›×œ ×ª×›× ×™×•×ª ×”×‘× ×™×™×Ÿ (×ª×‘"×¢) ×©×œ ×›×¤×¨ ×—×‘"×“.

**××” ×”×•× ×¢×•×©×”:**
1. ×œ×•×§×— ×¨×©×™××ª ×’×•×©×™× (12 ×‘×¨×™×¨×ª ××—×“×œ, ××• ×¡×¤×¦×™×¤×™×™×)
2. ××¨×™×¥ `ThreadPoolExecutor` ×¢× N threads (×‘×¨×™×¨×ª ××—×“×œ: 3)
3. ×›×œ thread ××¤×¢×™×œ `process_gush()` ×¢× Chrome driver ××©×œ×•
4. ×¡×•×¨×§ ×—×œ×§×•×ª 1-200 ×œ×›×œ ×’×•×©, ××•×¨×™×“ ×›×œ ××¡××š ×©× ××¦×

**×©×™××•×©:**
```bash
python download_plans.py                    # ×›×œ ×”×’×•×©×™×, 3 threads
python download_plans.py --workers 5        # 5 threads
python download_plans.py --gush 6260 6262   # ×’×•×©×™× ×¡×¤×¦×™×¤×™×™×
```

**×¤×œ×˜:** `kfar_chabad_data/plans/{×’×•×©}_{×—×œ×§×”}/{××¡×¤×¨_×ª×›× ×™×ª}/{×©×_××¡××š}.pdf`

---

### 4.3 `download_permits.py` â€“ ×”×•×¨×“×ª ×”×™×ª×¨×™ ×‘× ×™×™×”

**×ª×¤×§×™×“:** ×–×”×” ×œ-`download_plans.py` ××‘×œ ×¢×‘×•×¨ ×§×˜×’×•×¨×™×™×ª "×‘×§×©×•×ª ×œ×”×™×ª×¨ ×‘× ×™×™×”".

**×”×”×‘×“×œ ×-plans:** ×›×ª×•×‘×ª URL ×©×•× ×” ×‘××ª×¨ SDAN, selectors ×©×•× ×™× (×›×¤×ª×•×¨ "×”×¦×’" ×©×•× ×”, ×©×“×•×ª input ×©×•× ×™×).

**×©×™××•×©:**
```bash
python download_permits.py                  # ×›×œ ×”×’×•×©×™×
python download_permits.py --gush 6256      # ×’×•×© ×¡×¤×¦×™×¤×™
```

**×¤×œ×˜:** `kfar_chabad_data/permits/{×’×•×©}_{×—×œ×§×”}/{××¡×¤×¨_×‘×§×©×”}/{×©×_××¡××š}.pdf`

---

### 4.4 `download_aerial.py` â€“ ×”×•×¨×“×ª ×¦×™×œ×•××™ ××•×•×™×¨

**×ª×¤×§×™×“:** ××•×¨×™×“ ×¦×™×œ×•××™ ××•×•×™×¨ ××•×¨×ª×•×¤×•×˜×• ×”×™×¡×˜×•×¨×™×™× ×-GIS-net GeoServer ×¢× ×’×™××•×¨×¤×¨× ×¡ ××œ×.

**××¨×›×™×˜×§×˜×•×¨×”:**

```
Chrome (Selenium)
    â”‚
    â”œâ”€ ×¤×•×ª×— https://v5.gis-net.co.il/v5/Sdot_dan
    â”‚  (××§×‘×œ session cookies + proxy authentication)
    â”‚
    â””â”€ XHR requests ×“×¨×š proxy.ashx
        â”‚
        â””â”€ GeoServer WMTS GetTile
            â”œâ”€ LAYER=Sdot_dan_1965:1965
            â”œâ”€ TILEMATRIXSET=Sdot_dan
            â”œâ”€ TILEMATRIX=Sdot_dan:7
            â”œâ”€ TILEROW=55
            â””â”€ TILECOL=65
```

**××™×š ×–×” ×¢×•×‘×“:**
1. **Session establishment:** Selenium ×¤×•×ª×— ××ª ××ª×¨ GIS-net â†’ ×××ª×™×Ÿ ×œ×˜×¢×™× ×ª cookies
2. **Tile download via XHR:** ×‘××§×•× requests ×™×©×™×¨ (×©×—×¡×•× ×¢"×™ proxy), ××©×ª××© ×‘-`execute_async_script()` ×©×œ Selenium ×›×“×™ ×œ×©×œ×•×— XHR ××ª×•×š ×”×“×¤×“×¤×Ÿ â€“ ×›×›×” ×”-cookies ×•×”××™××•×ª ×¢×•×‘×¨×™× ××•×˜×•××˜×™×ª
3. **Tile stitching:** Pillow ×ª×•×¤×¨×ª ××ª ×›×œ ×”××¨×™×—×™× (tiles) ×œ×ª××•× ×” ××—×ª ×’×“×•×œ×”
4. **Georeferencing:** ×›×•×ª×‘ world file + PRJ + GeoTIFF (××•×¤×¦×™×•× ×œ×™)

**×¤×¨××˜×¨×™ WMTS (×-GetCapabilities):**
- **TileMatrixSet:** `Sdot_dan` â€“ 11 ×¨××•×ª (0-10)
- **CRS:** EPSG:2039
- **Origin:** (177118.8637, 664444.0) â€“ ×¤×™× ×” ×©×××œ×™×ª ×¢×œ×™×•× ×”
- **Tile size:** 256Ã—256 ×¤×™×§×¡×œ×™×
- **Scale denominators:** 256000 (×¨××” 0) â†’ 250 (×¨××” 10)
- **Pixel size:** ×¡×˜× ×“×¨×˜ OGC: `scale Ã— 0.00028 m`

**×©× ×•×ª ×¦×™×œ×•× ×–××™× ×•×ª (10):**

| ×©× ×” | ×©×›×‘×” | ×ª××¨×™×š |
|-----|------|-------|
| 1965 | `Sdot_dan_1965:1965` | 14.08.1965 |
| 1980 | `Sdot_dan_1980:sdot_dan_1980` | 09.1980 |
| 1980kc | `Sdot_dan_1980:×›×¤×¨ ×—×‘×“_1` | 09.1980 (×›×¤×¨ ×—×‘"×“) |
| 2008 | `Sdot_dan_2008:2008` | 2008 |
| 2017 | `Sdot_dan_2017:2017` | 03.2017 |
| 2019 | `Sdot_dan_2019:2019` | 12.04.2019 |
| 2020 | `Sdot_dan_2020:2020` | 05.02.2020 |
| 2022 | `Sdot_dan_2022:2022` | 15.12.2022 |
| 2025 | `Sdot_dan_2025:2025` | 2025 |
| 2025.04 | `Sdot_dan_2025.04:2025.04` | 19.04.2025 |

**×¨××•×ª ×–×•× ×‘×©×™××•×©:**

| ×¨××” | Pixel Size | ×˜×•×•×— ××¨×™×—×™× | ×¡×”"×› ××¨×™×—×™× |
|-----|-----------|-------------|-------------|
| 5 | 2.24 m/px | rows 10-20, cols 8-22 | ~165 |
| 7 | 0.56 m/px | rows 40-80, cols 32-88 | ~2,337 |

**×©×™××•×©:**
```bash
python download_aerial.py                           # 2025.04, level 5
python download_aerial.py --year 1965 --level 7     # 1965, 0.56 m/px
python download_aerial.py --year all --level 7      # ×›×œ ×”×©× ×™×
python download_aerial.py --level 7 --stitch        # + ×ª×¤×™×¨×” ×œ×ª××•× ×” ××—×ª
```

**×¤×œ×˜:**
- `gis_downloads/aerial/{year}/level_{N}/tile_{N}_{row}_{col}.jpg` â€“ ××¨×™×—×™× ×‘×•×“×“×™×
- `gis_downloads/aerial/{year}/aerial_level_{N}.jpg` â€“ ×ª××•× ×” ×ª×¤×•×¨×”
- `gis_downloads/aerial/{year}/aerial_level_{N}.jgw` â€“ world file
- `gis_downloads/aerial/{year}/aerial_level_{N}.prj` â€“ EPSG:2039

**××ª×’×¨×™× ×•×¤×ª×¨×•× ×•×ª:**
- ğŸ”§ **Proxy authentication:** GeoServer × ××¦× ×‘×¨×©×ª ×¤× ×™××™×ª (10.237.72.71) â†’ ×—×™×™×‘×™× ×œ×¢×‘×•×¨ ×“×¨×š `proxy.ashx` ×©××—×™×™×‘ session cookies â†’ ×¤×ª×¨×•×Ÿ: XHR ××ª×•×š ×“×¤×“×¤×Ÿ ×¢× cookies ×¤×¢×™×œ×™×
- ğŸ”§ **Session timeout:** ×‘×”×•×¨×“×•×ª ××¨×•×›×•×ª ×”×“×¤×“×¤×Ÿ × ×•×¤×œ â†’ Recovery mechanism â€“ ×©×•××¨ progress ×•××“×œ×’ ×¢×œ tiles ×©×›×‘×¨ ×™×¨×“×•
- ğŸ”§ **World file formula:** ×—×™×©×•×‘ ITM coordinates ×××™× ×“×§×¡ ××¨×™×—: `x = origin_x + col Ã— tile_span + pixel_size/2`
- ğŸ”§ **1999 missing:** ×©× ×ª 1999 ×§×™×™××ª ×¨×§ ×‘-ArcGIS REST ×•×œ× ×‘-GeoServer WMTS â†’ ×œ× × ×™×ª× ×ª ×œ×”×•×¨×“×” ×‘××•×ª×” ×©×™×˜×”

---

### 4.5 `georeference_plan.py` â€“ ×›×œ×™ ×’×™××•×¨×¤×¨× ×¡ ×œ×ª×©×¨×™×˜×™×

**×ª×¤×§×™×“:** ×›×œ×™ ×œ×”×¦××“×ª ×§×•××•×¨×“×™× ×˜×•×ª ×œ×ª×©×¨×™×˜×™ ×ª×›× ×•×Ÿ. ××§×‘×œ ×ª××•× ×” + × ×§×•×“×•×ª ×©×œ×™×˜×” (GCPs) ×•×™×•×¦×¨ world file.

**××¦×‘×™ ×¢×‘×•×“×”:**
1. **GCP mode (`--gcps`):** ××¡×¤×§ × ×§×•×“×•×ª pixelâ†’coordinate (××™× ×™××•× 3, ×¢×“×™×£ 4+)
2. **Bbox mode (`--bbox`):** ××¡×¤×§ bounding box (xmin,ymin,xmax,ymax)
3. **Config mode (`--config`):** ×˜×•×¢×Ÿ GCPs ××§×•×‘×¥ JSON
4. **Template mode (`--template`):** ××™×™×¦×¨ ×ª×‘× ×™×ª JSON ×œ×›×œ ×ª××•× ×”

**××œ×’×•×¨×™×ª×:**
- **Affine transformation:** ×¤×ª×¨×•×Ÿ Least Squares ×©×œ ××˜×¨×™×¦×ª ×˜×¨× ×¡×¤×•×¨××¦×™×” ××¤×™× ×™×ª 2Ã—3:
  ```
  [coord_x]   [a  b  c] [pixel_x]
  [coord_y] = [d  e  f] [pixel_y]
                         [  1   ]
  ```
  ××ª×•×š 3+ GCPs, × ×¤×ª×¨ ×¢"×™ `np.linalg.lstsq()`.

- **World file format:** 6 ×©×•×¨×•×ª:
  ```
  A  (pixel size X direction)
  D  (rotation Y)
  B  (rotation X)
  E  (pixel size Y direction, negative)
  C  (X coordinate of upper-left pixel center)
  F  (Y coordinate of upper-left pixel center)
  ```

**×©×™××•×©:**
```bash
# Bounding box:
python georeference_plan.py plan.jpg --bbox 185500,654000,188000,657000

# GCPs:
python georeference_plan.py plan.jpg \
  --gcps 100,50,185500,657000  5000,50,188000,657000 \
         100,4000,185500,654000  5000,4000,188000,654000

# Config JSON:
python georeference_plan.py plan.jpg --config plan_gcps.json

# PDF:
python georeference_plan.py plan.pdf --bbox 185500,654000,188000,657000
```

**×¤×œ×˜:**
- `{image_name}.jgw` â€“ World file
- `{image_name}.prj` â€“ Projection file (EPSG:2039)
- `{image_name}.tif` â€“ GeoTIFF (×¢× `--geotiff`)

---

### 4.6 `generate_georef.py` â€“ ×’×™××•×¨×¤×¨× ×¡ ××•×˜×•××˜×™ ×œ×›×œ ×”×ª×©×¨×™×˜×™×

**×ª×¤×§×™×“:** ×¡×•×¨×§ ××ª ×›×œ ×ª×™×§×™×™×ª `kfar_chabad_data/plans/`, ××•×¦× ×ª×©×¨×™×˜×™× (JPG/PDF), ×•××™×™×¦×¨ world files ××•×˜×•××˜×™×ª.

**××” ×”×•× ×¢×•×©×”:**
1. ×¡×•×¨×§ recursively ××ª ×ª×™×§×™×™×ª plans
2. ××–×”×” ×§×‘×¦×™× ×¢× "×ª×©×¨×™×˜" ××• "×ª×•×›× ×™×ª" ×‘×©×
3. ×××™×¨ PDFs ×œ×ª××•× ×•×ª PNG ×‘-300 DPI (×“×¨×š PyMuPDF)
4. ××—×©×‘ ×”×¢×¨×›×ª ×§×•××•×¨×“×™× ×˜×•×ª ×¢×œ ×‘×¡×™×¡:
   - ××¨×›×– ×›×¤×¨ ×—×‘"×“: **(187,353, 655,659)** â€“ × ×©×œ×£ ×-GovMap
   - ×§× "× ××©×•×¢×¨: **1:2500**
   - ××¡×’×¨×ª ××¤×” ×©×–×•×”×ª×”: **(25.8%â€“78.0%)** ×¨×•×—×‘, **(26.7%â€“83.7%)** ×’×•×‘×”
5. ×›×•×ª×‘ world file + PRJ ×œ×›×œ ×ª×©×¨×™×˜
6. ××¢×ª×™×§ ×œ-9 ×ª×™×§×™×•×ª ×›×¤×•×œ×•×ª ×©×œ ××•×ª×• ×ª×©×¨×™×˜
7. ×©×•××¨ config JSON ×œ×™×™×—×•×¡

**×—×™×©×•×‘ ×”×§×•××•×¨×“×™× ×˜×•×ª:**
```
ground_width  = (image_width  / DPI Ã— 2.54) Ã— scale / 100
ground_height = (image_height / DPI Ã— 2.54) Ã— scale / 100

// ××¡×’×¨×ª ×”××¤×” ×××•×¨×›×–×ª ×¢×œ ×”×™×©×•×‘:
xmin = center_x - frame_center_x_pct Ã— ground_width
ymax = center_y + frame_center_y_pct Ã— ground_height
```

**×ª×•×¦××•×ª:**

| ×ª×©×¨×™×˜ | ×’×•×“×œ | Ground Extent | Bbox |
|--------|------|--------------|------|
| ×ª×©×¨×™×˜.jpg (×’×–/12/525) | 11146Ã—5919 px | 4718Ã—2506 m | X: 184,904â€“189,623 |
| ×ª×©×¨×™×˜ 27×.pdf â†’ PNG | 13225Ã—12838 px | 5599Ã—5435 m | X: 184,447â€“190,046 |
| ×ª×•×›× ×™×ª ×‘×™× ×•×™.pdf â†’ PNG | 10800Ã—19544 px | 4572Ã—8274 m | X: 184,980â€“189,552 |

---

### 4.7 `run_all.py` â€“ ×”×¨×¦×” ×›×•×œ×œ×ª

**×ª×¤×§×™×“:** ××¤×¢×™×œ ××ª ×›×œ ×”×¡×§×¨×™×¤×˜×™× ×‘×¨×¦×£ ××—×“ ×¢× CLI ××—×™×“.

**×§×˜×’×•×¨×™×•×ª:**
1. `plans` â€“ ×ª×›× ×™×•×ª (×“×¨×š `sdan_common.process_gush`)
2. `permits` â€“ ×”×™×ª×¨×™× (×“×¨×š `sdan_common.process_gush`)
3. `aerial` â€“ ×¦×™×œ×•××™ ××•×•×™×¨ (×“×¨×š `download_aerial`)
4. `georef` â€“ ×’×™××•×¨×¤×¨× ×¡ (×“×¨×š `generate_georef`)

**×©×™××•×©:**
```bash
python run_all.py                           # ×”×›×œ
python run_all.py --category plans permits  # ×¨×§ ××¡××›×™×
python run_all.py --category aerial         # ×¨×§ ×¦×™×œ×•× ××•×•×™×¨
python run_all.py --category georef         # ×¨×§ ×’×™××•×¨×¤×¨× ×¡
python run_all.py --aerial-year all --aerial-level 7 --stitch
```

---

## 5. ××¡×“ ×”× ×ª×•× ×™×

**×§×•×‘×¥:** `kfar_chabad_documents.db` (SQLite)

**×¡×›××”:**
```sql
CREATE TABLE documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    gush INTEGER,
    helka INTEGER,
    plan_number TEXT,
    title TEXT,
    file_path TEXT,
    category TEXT,          -- "plans" / "permits"
    downloaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

×××¤×©×¨ ×œ×©××•×œ: "×›××” ××¡××›×™× ×™×© ×œ×’×•×© 6256?", "×›××” ×ª×›× ×™×•×ª ×œ×¢×•××ª ×”×™×ª×¨×™×", ×•×›×•'.

---

## 6. ××” ×”×¦×œ×™×— âœ…

### 6.1 ×’×¨×™×“×ª ××¡××›×™ SDAN
- âœ… ×”×•×¨×“×ª ×›×œ ×ª×›× ×™×•×ª ×”×‘× ×™×™×” ×¢×‘×•×¨ 12 ×’×•×©×™× Ã— 200 ×—×œ×§×•×ª
- âœ… ×”×•×¨×“×ª ×›×œ ×”×™×ª×¨×™ ×”×‘× ×™×™×”
- âœ… × ×™×”×•×œ session, cookies, modals, anti-bot
- âœ… ×¨×™×¦×” ××§×‘×™×œ×™×ª (3+ threads), ×›×œ thread ×¢× Chrome ××©×œ×•
- âœ… Recovery â€“ ×“×™×œ×•×’ ×¢×œ ×§×‘×¦×™× ×©×›×‘×¨ ×™×¨×“×•

### 6.2 ×¦×™×œ×•××™ ××•×•×™×¨
- âœ… ×”×•×¨×“×ª **10 ×©× ×•×ª ×¦×™×œ×•×** (1965â€“2025) ×‘×¨××•×ª 5 ×•-7
- âœ… **×’×™××•×¨×¤×¨× ×¡ ××œ×** â€“ world files + PRJ + GeoTIFF ××•×¤×¦×™×•× ×œ×™
- âœ… ×ª×¤×™×¨×” ×œ×ª××•× ×” ××—×ª (14,080Ã—10,496 px ×‘×¨××” 7)
- âœ… ×—×™×©×•×‘ ××“×•×™×§ ×©×œ pixel size ×•-origin ××ª×•×š ×¤×¨××˜×¨×™ WMTS
- âœ… Session recovery ××—×¨×™ ×§×¨×™×¡×ª ×“×¤×“×¤×Ÿ

### 6.3 ×’×™××•×¨×¤×¨× ×¡ ×ª×©×¨×™×˜×™×
- âœ… ×›×œ×™ ×’×™××•×¨×¤×¨× ×¡ ××œ× ×¢× 4 ××¦×‘×™ ×¢×‘×•×“×”
- âœ… ×ª××™×›×” ×‘-PDFâ†’PNG ××•×˜×•××˜×™ (300 DPI)
- âœ… ×ª××™×›×” ×‘-EPSG:2039 ×•-EPSG:6991
- âœ… ×”×¢×¨×›×” ×¨××©×•× ×™×ª ××•×˜×•××˜×™×ª ×¢×œ ×‘×¡×™×¡ ××¨×›×– ×™×©×•×‘ + ×§× "× ××©×•×¢×¨
- âœ… ××™×ª×•×¨ ××¨×›×– ×›×¤×¨ ×—×‘"×“ ×“×¨×š GovMap: (187,352.89, 655,659.07)

---

## 7. ××” × ×ª×§×œ ×‘×‘×¢×™×•×ª âš ï¸

### 7.1 ×©×œ×™×¤×ª ×’×‘×•×œ ×ª×›× ×™×ª â€“ ×›×œ ×”-APIs × ×›×©×œ×•

× ×™×¡×™× ×• **6 ×’×™×©×•×ª ×©×•× ×•×ª** ×œ×©×œ×•×£ ××ª ×”×’×‘×•×œ ×”××“×•×™×§ ×©×œ ×ª×›× ×™×ª ×’×–/12/525:

| × ×™×¡×™×•×Ÿ | ×©×™×˜×” | ×ª×•×¦××” |
|--------|------|-------|
| 1 | SDAN GIS Map (Selenium) | â›” ×”××¤×” ×œ× × ×˜×¢× ×” ×ª×•×š 60 ×©× ×™×•×ª, WAF ×—×¡× |
| 2 | IPA (mavat.iplan.gov.il) API | â›” `SSLV3_ALERT_HANDSHAKE_FAILURE` â€“ ×©×’×™××ª SSL |
| 3 | GovMap ArcGIS REST | â›” ××—×–×™×¨ HTML ×‘××§×•× JSON, APIs ××—×–×™×¨×™× 404 |
| 4 | SDAN Internal ArcGIS | â›” ×¨×§ ×©×›×‘×•×ª ×‘×¡×™×¡×™×•×ª (×™×©×•×‘×™×, ×›×‘×™×©×™×) â€“ ××™×Ÿ ×’×‘×•×œ×•×ª ×ª×›× ×™×•×ª |
| 5 | GovMap fetch/XHR ××“×¤×“×¤×Ÿ | â›” CORS + SSL failures |
| 6 | GovMap Selenium Search | âœ… **×—×œ×§×™** â€“ ××¦× ××¨×›×– ×™×©×•×‘ ××‘×œ ×œ× ×’×‘×•×œ ×ª×›× ×™×ª |

**×”×¡×™×‘×”:** ×›×œ ××¢×¨×›×•×ª ×”-GIS ×”×××©×œ×ª×™×•×ª ×‘×™×©×¨××œ ××•×’× ×•×ª ×‘-WAF, proxy, ××™××•×ª session, ×•××—×–×™×¨×•×ª HTML ×‘××§×•× JSON ×œ-API calls ×™×©×™×¨×•×ª.

### 7.2 Feature Matching (×”×ª×××ª ×¤×™×¦'×¨×™×)

× ×™×¡×™× ×• ×œ×”×ª××™× ××ª ×”×ª×©×¨×™×˜ ×œ×¦×™×œ×•× ××•×•×™×¨ ××•×˜×•××˜×™×ª ×‘×××¦×¢×•×ª ORB features:

- **×ª×•×¦××”:** 16 inliers ××ª×•×š 383 matches â†’ **4.2% ×‘×œ×‘×“**
- **×”×ª××•× ×” ×©× ×•×¦×¨×”:** 103m Ã— 71m (×¦×¨×™×š ×œ×”×™×•×ª ~2500m Ã— 1400m)
- **×”×¡×™×‘×”:** ×ª×©×¨×™×˜ ×ª×›× ×•× ×™ ×”×•× **×¦×™×•×¨ ×¡×›××˜×™** (×§×•×•×™×, ×¦×‘×¢×™×, ×˜×§×¡×˜) â€“ ×©×•× ×” ×œ×—×œ×•×˜×™×Ÿ ××¦×™×œ×•× ××•×•×™×¨. ×©×™×˜×ª feature matching ×¢×•×‘×“×ª ×¨×§ ×‘×™×Ÿ ×ª××•× ×•×ª ×“×•××•×ª (×œ××©×œ ×©× ×™ ×¦×™×œ×•××™ ××•×•×™×¨).

### 7.3 OCR ×¢×œ ×§×•××•×¨×“×™× ×˜×•×ª

× ×™×¡×™× ×• ×œ×§×¨×•× ××¡×¤×¨×™ ×¨×©×ª ×§×•××•×¨×“×™× ×˜×•×ª ××’×‘×•×œ×•×ª ×”××¤×”:

- **××” ×”×¦×œ×™×—:** ×–×™×”×•×™ ××¡×¤×¨×™ ×’×•×©: 6256, 6258, 6260, 6262, 6269, 6272 âœ…
- **××” × ×›×©×œ:** ×§×¨×™××ª ×¢×¨×›×™ ×§×•××•×¨×“×™× ×˜×•×ª ××¨×©×ª ×”××¤×” â›”
- **×”×¡×™×‘×”:** ×”×¡×¨×™×§×” ×‘-150 DPI â€“ × ××•×š ××“×™ ×œ×˜×§×¡×˜ ×§×˜×Ÿ ×¢×œ ×’×‘×•×œ×•×ª. ×¦×¨×™×š 300+ DPI.
- **×˜×›× ×™×§×•×ª ×©× ×•×¡×•:** upscaling Ã—4, binary thresholding, multiple PSM modes, inverted detection, 8 border regions

### 7.4 OpenCV + × ×ª×™×‘×™ ×§×‘×¦×™× ×‘×¢×‘×¨×™×ª

OpenCV ×œ× ××¡×•×’×œ ×œ×¤×ª×•×— ×§×‘×¦×™× ×¢× × ×ª×™×‘ ×‘×¢×‘×¨×™×ª:
```python
cv2.imread("C:\...\×©×•×œ×—×Ÿ ×”×¢×‘×•×“×”\...\×ª×©×¨×™×˜.jpg")  # â†’ None
```
**×¤×ª×¨×•×Ÿ:** ×©×™××•×© ×‘-PIL ×›-fallback â† ×”××¨×” ×œ-numpy array.

---

## 8. ××¨×›×™×˜×§×˜×•×¨×” ×˜×›× ×™×ª â€“ ×ª×¨×©×™×

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    run_all.py    â”‚
                    â”‚  (orchestrator)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼               â–¼               â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ plans.py â”‚   â”‚permits.pyâ”‚   â”‚ aerial.py  â”‚   â”‚georef.py â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚               â”‚                â”‚
         â–¼              â–¼               â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚sdan_common â”‚              â”‚  Selenium   â”‚    â”‚  PIL/numpy â”‚
    â”‚  .py       â”‚              â”‚  XHRâ†’WMTS   â”‚    â”‚  + PyMuPDF â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Selenium  â”‚               â”‚ GeoServer    â”‚
    â”‚â†’ SDAN    â”‚               â”‚ WMTS tiles   â”‚
    â”‚  site    â”‚               â”‚ via proxy    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚requests  â”‚
    â”‚â†’ archive â”‚
    â”‚  CDN     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. ×¤×¨××˜×¨×™ WMTS â€“ ×”×¡×‘×¨ ×˜×›× ×™

×”-GeoServer ×©×××—×•×¨×™ GIS-net ××©×ª××© ×‘-**WMTS (Web Map Tile Service)** â€“ ×¡×˜× ×“×¨×˜ OGC.

### TileMatrixSet: `Sdot_dan`

```
Origin (TopLeftCorner): X=177,118.8637  Y=664,444.0  (EPSG:2039)
Tile Size: 256 Ã— 256 pixels
CRS: EPSG:2039 (Israel TM Grid)
```

### ×—×™×©×•×‘ ×§×•××•×¨×“×™× ×˜×•×ª ×××¨×™×—:

```python
pixel_size = scale_denominator Ã— 0.00028     # OGC standard
tile_span  = pixel_size Ã— 256                # ground meters per tile

# Upper-left corner of tile (row, col):
x = 177118.8637 + col Ã— tile_span
y = 664444.0    - row Ã— tile_span
```

### ×—×™×©×•×‘ World File:

```python
# Line 1: A = pixel size in X direction
# Line 2: D = rotation (always 0 for north-up)
# Line 3: B = rotation (always 0)
# Line 4: E = -pixel_size (negative = Y going down)
# Line 5: C = X of upper-left pixel CENTER
# Line 6: F = Y of upper-left pixel CENTER

C = origin_x + col_min Ã— tile_span + pixel_size / 2
F = origin_y - row_min Ã— tile_span - pixel_size / 2
```

---

## 10. ×©×™×˜×ª ×”×’×¨×™×“×” ×-SDAN â€“ ×”×¡×‘×¨

```
1. Chrome â†’ https://sdan.complot.co.il/binyan/
2. ×“×—×™×™×ª ×‘×× ×¨ cookies
3. ×œ×—×™×¦×” ×¢×œ radio "×’×•×© ×•×—×œ×§×”"
4. ××™×œ×•×™ ×©×“×” ×’×•×© (×œ××©×œ 6256)
5. ××™×œ×•×™ ×©×“×” ×—×œ×§×” (1, 2, 3, ..., 200)
6. ×œ×—×™×¦×” ×¢×œ "×”×¦×’"
7. ×”××ª× ×” ×œ×˜×‘×œ×ª ×ª×•×¦××•×ª (timeout = 20s)
   â””â”€â”€ ×× ××™×Ÿ ×ª×•×¦××•×ª â†’ ×—×œ×§×” ×”×‘××”
8. ×œ×›×œ ×©×•×¨×” ×‘×˜×‘×œ×”:
   a. ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ "××¨×›×™×•×Ÿ" (openBtn)
   b. ×”××ª× ×” ×œ-modal ×©× ×¤×ª×—
   c. ×—×™×œ×•×¥ ×œ×™× ×§×™ ××¡××›×™× ×-#modalcontent
   d. ×”×•×¨×“×ª ×›×œ ×§×•×‘×¥ ×“×¨×š requests (×-CDN ×©×œ archive.gis-net.co.il)
   e. ×¨×™×©×•× ×‘-SQLite
   f. ×¡×’×™×¨×ª modal
9. ×—×–×¨×” ×œ-5 ×¢× ×—×œ×§×” ×”×‘××”
```

---

## 11. ×”××œ×¦×•×ª ×œ×”××©×š

1. **××™××•×ª ×’×™××•×¨×¤×¨× ×¡:** ×œ×¤×ª×•×— ××ª ×”×ª×©×¨×™×˜ + ×¦×™×œ×•× ××•×•×™×¨ ×‘-QGIS ×•×œ×‘×“×•×§ ×—×¤×™×¤×”. ×”×§×•××•×¨×“×™× ×˜×•×ª ×”×Ÿ ×”×¢×¨×›×” ×¨××©×•× ×™×ª.

2. **×©×™×¤×•×¨ ×“×™×•×§:** ×× ×™×© ××™×©×”×• ×©×™×›×•×œ ×œ×§×¨×•× ××¡×¤×¨×™ ×¨×©×ª ×§×•××•×¨×“×™× ×˜×•×ª ××’×‘×•×œ×•×ª ×”××¤×” â€“ ×œ×”×›× ×™×¡ ×›-GCPs:
   ```bash
   python georeference_plan.py ×ª×©×¨×™×˜.jpg \
     --gcps 2875,1581,X1,Y1  8694,1581,X2,Y1  2875,4953,X1,Y2  8694,4953,X2,Y2
   ```

3. **×¡×¨×™×§×” ××—×“×© ×‘-300 DPI:** ×× × ×™×ª×Ÿ, ×¡×¨×™×§×” ×—×“×©×” ×©×œ ×”×ª×©×¨×™×˜ ×‘-300+ DPI ×ª××¤×©×¨ OCR ××•×˜×•××˜×™ ×©×œ ×”×§×•××•×¨×“×™× ×˜×•×ª.

4. **×©× ×ª 1999:** ×¦×™×œ×•× ×”××•×•×™×¨ ×©×œ 1999 ×§×™×™× ×¨×§ ×‘-ArcGIS REST ×•×œ× ×‘-WMTS. ××¤×©×¨ ×œ×”×•×¡×™×£ WMS GetMap request.

5. **×ª×©×¨×™×˜×™× × ×•×¡×¤×™×:** ×× ×™×ª×•×•×¡×¤×• ×ª×©×¨×™×˜×™× ×—×“×©×™×, ×œ×”×¨×™×¥ `python run_all.py --category georef` ×›×“×™ ×œ×¢×“×›×Ÿ.

---

## 12. ×“×¨×™×©×•×ª ××¢×¨×›×ª

```
Python >= 3.10
Google Chrome (×¢×“×›× ×™)
~2 GB disk (×¦×™×œ×•××™ ××•×•×™×¨ ×‘×¨××” 7)
×—×™×‘×•×¨ ××™× ×˜×¨× ×˜ (×œ×”×•×¨×“×”)
```

### ×”×ª×§× ×ª ×ª×œ×•×™×•×ª:
```bash
python -m venv .venv
.venv\Scripts\activate
pip install selenium webdriver-manager requests Pillow numpy pymupdf opencv-python-headless pytesseract
```

---

*× ×•×¦×¨ ××•×˜×•××˜×™×ª â€“ ×¤×¨×•×™×§×˜ ×”×•×¨×“×ª ××¡××›×™ ×ª×›× ×•×Ÿ ×›×¤×¨ ×—×‘"×“*
